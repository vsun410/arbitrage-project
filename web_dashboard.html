<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íŠ¸ë ˆì´ë”© ëª¨ë‹ˆí„° | 48.5% ìµœì í™” ì „ëµ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .status-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin: 10px;
            min-width: 200px;
            text-align: center;
        }
        
        .status-card h3 {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        
        .status-card .value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #333;
        }
        
        .market-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .market-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .market-card h2 {
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .symbol {
            font-size: 1.5rem;
        }
        
        .timestamp {
            font-size: 0.8rem;
            color: #999;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .metric:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            color: #666;
            font-weight: 500;
        }
        
        .metric-value {
            font-weight: bold;
            color: #333;
        }
        
        .positive {
            color: #4CAF50;
        }
        
        .negative {
            color: #F44336;
        }
        
        .neutral {
            color: #FF9800;
        }
        
        .positions-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .positions-section h2 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .position-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .position-item:last-child {
            border-bottom: none;
        }
        
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 25px;
            color: white;
            font-weight: bold;
            z-index: 1000;
        }
        
        .connected {
            background: #4CAF50;
        }
        
        .disconnected {
            background: #F44336;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: white;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .status-bar {
                flex-direction: column;
            }
            
            .market-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">ì—°ê²° ì¤‘...</div>
    
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š íŠ¸ë ˆì´ë”© ëª¨ë‹ˆí„°</h1>
            <p>48.5% ì—°ìˆ˜ìµë¥  ìµœì í™” ì „ëµ | Z-Score ê¸°ë°˜ ì‹¤ì‹œê°„ ê±°ë˜ ì‹œìŠ¤í…œ</p>
        </div>
        
        <div class="loading" id="loadingDiv">
            <div class="loading-spinner"></div>
            <p>API ì„œë²„ ì—°ê²° ì¤‘...</p>
        </div>
        
        <div id="mainContent" style="display: none;">
            <div class="status-bar">
                <div class="status-card">
                    <h3>ì‹œìŠ¤í…œ ìƒíƒœ</h3>
                    <div class="value" id="systemStatus">-</div>
                </div>
                <div class="status-card">
                    <h3>í™œì„± í¬ì§€ì…˜</h3>
                    <div class="value" id="activePositions">-</div>
                </div>
                <div class="status-card">
                    <h3>ì´ ì†ìµ</h3>
                    <div class="value" id="totalPnl">-</div>
                </div>
                <div class="status-card">
                    <h3>ê±°ë˜ ëª¨ë“œ</h3>
                    <div class="value" id="tradingMode">-</div>
                </div>
                <div class="status-card">
                    <h3>ìŠ¹ë¥ </h3>
                    <div class="value" id="winRate">-</div>
                </div>
                <div class="status-card">
                    <h3>í™˜ìœ¨ (USD/KRW)</h3>
                    <div class="value" id="usdKrwRate">-</div>
                </div>
            </div>
            
            <div class="market-grid" id="marketGrid">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
            </div>
            
            <div class="positions-section">
                <h2>ğŸ“Š í˜„ì¬ í¬ì§€ì…˜</h2>
                <div id="positionsList">
                    <p style="text-align: center; color: #999; padding: 20px;">í¬ì§€ì…˜ì´ ì—†ìŠµë‹ˆë‹¤</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';
        const WS_URL = 'ws://localhost:8080/ws';
        
        let ws = null;
        let reconnectInterval = null;
        
        // DOM ìš”ì†Œë“¤
        const connectionStatus = document.getElementById('connectionStatus');
        const loadingDiv = document.getElementById('loadingDiv');
        const mainContent = document.getElementById('mainContent');
        const systemStatus = document.getElementById('systemStatus');
        const activePositions = document.getElementById('activePositions');
        const totalPnl = document.getElementById('totalPnl');
        const tradingMode = document.getElementById('tradingMode');
        const winRate = document.getElementById('winRate');
        const usdKrwRate = document.getElementById('usdKrwRate');
        const marketGrid = document.getElementById('marketGrid');
        const positionsList = document.getElementById('positionsList');
        
        // ì´ˆê¸°í™”
        async function init() {
            try {
                // API ì„œë²„ ìƒíƒœ í™•ì¸
                const healthCheck = await fetch(`${API_BASE}/health`);
                if (!healthCheck.ok) throw new Error('API ì„œë²„ ì‘ë‹µ ì—†ìŒ');
                
                loadingDiv.style.display = 'none';
                mainContent.style.display = 'block';
                
                // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
                await loadInitialData();
                
                // WebSocket ì—°ê²°
                connectWebSocket();
                
                // ì£¼ê¸°ì  ë°ì´í„° ê°±ì‹  (WebSocket ë°±ì—…)
                setInterval(loadInitialData, 30000);
                
            } catch (error) {
                console.error('ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                connectionStatus.textContent = 'API ì„œë²„ ì—°ê²° ì‹¤íŒ¨';
                connectionStatus.className = 'connection-status disconnected';
            }
        }
        
        // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
        async function loadInitialData() {
            try {
                // ì‹œìŠ¤í…œ ìƒíƒœ
                const statusResponse = await fetch(`${API_BASE}/api/system-status`);
                if (statusResponse.ok) {
                    const status = await statusResponse.json();
                    updateSystemStatus(status);
                }
                
                // ì‹œì¥ ë°ì´í„°
                const marketResponse = await fetch(`${API_BASE}/api/market-data`);
                if (marketResponse.ok) {
                    const marketData = await marketResponse.json();
                    updateMarketGrid(marketData);
                }
                
                // í¬ì§€ì…˜
                const positionsResponse = await fetch(`${API_BASE}/api/positions`);
                if (positionsResponse.ok) {
                    const positions = await positionsResponse.json();
                    updatePositions(positions);
                }
                
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }
        
        // WebSocket ì—°ê²°
        function connectWebSocket() {
            try {
                ws = new WebSocket(WS_URL);
                
                ws.onopen = () => {
                    connectionStatus.textContent = 'ì‹¤ì‹œê°„ ì—°ê²°ë¨';
                    connectionStatus.className = 'connection-status connected';
                    
                    // êµ¬ë… ìš”ì²­
                    ws.send(JSON.stringify({
                        type: 'subscribe',
                        data: { subscription: 'market_data' }
                    }));
                };
                
                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        handleWebSocketMessage(data);
                    } catch (error) {
                        console.error('WebSocket ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜:', error);
                    }
                };
                
                ws.onclose = () => {
                    connectionStatus.textContent = 'ì—°ê²° ëŠì–´ì§';
                    connectionStatus.className = 'connection-status disconnected';
                    
                    // ì¬ì—°ê²° ì‹œë„
                    if (!reconnectInterval) {
                        reconnectInterval = setInterval(() => {
                            connectWebSocket();
                        }, 5000);
                    }
                };
                
                ws.onerror = (error) => {
                    console.error('WebSocket ì˜¤ë¥˜:', error);
                };
                
            } catch (error) {
                console.error('WebSocket ì—°ê²° ì‹¤íŒ¨:', error);
                connectionStatus.textContent = 'WebSocket ì—°ê²° ì‹¤íŒ¨';
                connectionStatus.className = 'connection-status disconnected';
            }
        }
        
        // WebSocket ë©”ì‹œì§€ ì²˜ë¦¬
        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'market_data':
                    updateMarketGrid(data.data);
                    break;
                case 'system_status':
                    updateSystemStatus(data.data);
                    break;
                case 'position_update':
                    loadInitialData(); // í¬ì§€ì…˜ ì—…ë°ì´íŠ¸ì‹œ ì „ì²´ ìƒˆë¡œê³ ì¹¨
                    break;
                case 'heartbeat':
                    // ì—°ê²° ìœ ì§€
                    break;
            }
        }
        
        // ì‹œìŠ¤í…œ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateSystemStatus(status) {
            systemStatus.textContent = status.is_running ? 'ì‹¤í–‰ ì¤‘' : 'ì¤‘ì§€ë¨';
            systemStatus.className = status.is_running ? 'value positive' : 'value negative';
            
            activePositions.textContent = status.active_positions || 0;
            
            const pnl = status.total_pnl_krw || 0;
            totalPnl.textContent = `${(pnl/10000).toFixed(1)}ë§Œì›`;
            totalPnl.className = pnl > 0 ? 'value positive' : pnl < 0 ? 'value negative' : 'value';
            
            // ê±°ë˜ ëª¨ë“œ í‘œì‹œ
            tradingMode.textContent = status.dry_run ? 'ëª¨ì˜ê±°ë˜' : 'ì‹¤ê±°ë˜';
            tradingMode.className = status.dry_run ? 'value neutral' : 'value positive';
            
            // ìŠ¹ë¥  í‘œì‹œ
            const winRateValue = status.win_rate || 0;
            winRate.textContent = `${winRateValue.toFixed(1)}%`;
            winRate.className = winRateValue > 80 ? 'value positive' : winRateValue > 60 ? 'value neutral' : 'value negative';
            
            usdKrwRate.textContent = (status.usd_krw_rate || 0).toLocaleString();
        }
        
        // ì‹œì¥ ë°ì´í„° ì—…ë°ì´íŠ¸
        function updateMarketGrid(marketData) {
            marketGrid.innerHTML = '';
            
            Object.entries(marketData).forEach(([symbol, data]) => {
                const card = createMarketCard(symbol, data);
                marketGrid.appendChild(card);
            });
        }
        
        // ì‹œì¥ ì¹´ë“œ ìƒì„±
        function createMarketCard(symbol, data) {
            const card = document.createElement('div');
            card.className = 'market-card';
            
            const kimp = data.kimp || 0;
            const zscore = data.zscore || 0;
            const timestamp = new Date(data.timestamp).toLocaleTimeString();
            
            card.innerHTML = `
                <h2>
                    <span class="symbol">${symbol}</span>
                    <span class="timestamp">${timestamp}</span>
                </h2>
                <div class="metric">
                    <span class="metric-label">í”„ë¦¬ë¯¸ì—„</span>
                    <span class="metric-value ${kimp > 0 ? 'positive' : kimp < 0 ? 'negative' : 'neutral'}">${kimp.toFixed(2)}%</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Z-Score</span>
                    <span class="metric-value ${getZScoreStatusClass(zscore)}">${zscore.toFixed(3)}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">ì „ëµ ì‹ í˜¸</span>
                    <span class="metric-value ${getStrategySignalClass(zscore)}">${getStrategySignal(zscore)}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">ì—…ë¹„íŠ¸ ê°€ê²©</span>
                    <span class="metric-value">${(data.upbit_price || 0).toLocaleString()}ì›</span>
                </div>
                <div class="metric">
                    <span class="metric-label">ë°”ì´ë‚¸ìŠ¤ ê°€ê²©</span>
                    <span class="metric-value">$${(data.binance_price || 0).toLocaleString()}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">í™˜ìœ¨</span>
                    <span class="metric-value">${(data.usd_krw || 0).toLocaleString()}</span>
                </div>
            `;
            
            return card;
        }
        
        // í¬ì§€ì…˜ ì—…ë°ì´íŠ¸
        function updatePositions(positions) {
            if (!positions || positions.length === 0) {
                positionsList.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">í¬ì§€ì…˜ì´ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }
            
            positionsList.innerHTML = '';
            positions.forEach(position => {
                const item = document.createElement('div');
                item.className = 'position-item';
                
                const pnl = position.current_pnl || 0;
                const pnlPct = position.current_pnl_pct || 0;
                
                item.innerHTML = `
                    <div>
                        <strong>${position.symbol}</strong>
                        <span style="margin-left: 10px; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; background: ${position.side === 'long' ? '#e8f5e8' : '#ffe8e8'}; color: ${position.side === 'long' ? '#2e7d2e' : '#d32f2f'};">
                            ${position.side.toUpperCase()}
                        </span>
                    </div>
                    <div style="text-align: right;">
                        <div class="${pnl > 0 ? 'positive' : pnl < 0 ? 'negative' : 'neutral'}" style="font-weight: bold;">
                            ${pnl.toLocaleString()}ì› (${pnlPct.toFixed(2)}%)
                        </div>
                        <div style="font-size: 0.8rem; color: #999;">
                            ì§„ì…: ${position.entry_kimp.toFixed(2)}%
                        </div>
                    </div>
                `;
                
                positionsList.appendChild(item);
            });
        }
        
        // Z-Score ìƒíƒœ í´ë˜ìŠ¤ ë°˜í™˜
        function getZScoreStatusClass(zscore) {
            const abs = Math.abs(zscore);
            if (abs >= 4.0) return 'negative'; // ì´ˆê·¹ë‹¨ - ë¹¨ê°„ìƒ‰
            if (abs >= 3.0) return 'neutral';  // ê·¹ë‹¨ - ì£¼í™©ìƒ‰
            if (abs >= 2.0) return 'positive'; // ì¼ë°˜ - ë…¹ìƒ‰
            return '';  // ì •ìƒ
        }
        
        // ì „ëµ ì‹ í˜¸ í…ìŠ¤íŠ¸ ë°˜í™˜
        function getStrategySignal(zscore) {
            const abs = Math.abs(zscore);
            if (abs >= 4.0) return 'ì´ˆê·¹ë‹¨ (40%)';
            if (abs >= 3.0) return 'ê·¹ë‹¨ (2ë°°)';
            if (abs >= 2.0) return 'ì§„ì… ì‹ í˜¸';
            return 'ëŒ€ê¸°';
        }
        
        // ì „ëµ ì‹ í˜¸ í´ë˜ìŠ¤ ë°˜í™˜
        function getStrategySignalClass(zscore) {
            const abs = Math.abs(zscore);
            if (abs >= 4.0) return 'negative';  // ì´ˆê·¹ë‹¨
            if (abs >= 3.0) return 'neutral';   // ê·¹ë‹¨
            if (abs >= 2.0) return 'positive';  // ì¼ë°˜
            return '';
        }
        
        // í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', init);
        
        // í˜ì´ì§€ ì¢…ë£Œì‹œ WebSocket ì •ë¦¬
        window.addEventListener('beforeunload', () => {
            if (ws) {
                ws.close();
            }
            if (reconnectInterval) {
                clearInterval(reconnectInterval);
            }
        });
    </script>
</body>
</html>