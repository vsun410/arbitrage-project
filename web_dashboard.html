<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>트레이딩 모니터 | 48.5% 최적화 전략</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .status-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin: 10px;
            min-width: 200px;
            text-align: center;
        }
        
        .status-card h3 {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        
        .status-card .value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #333;
        }
        
        .market-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .market-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .market-card h2 {
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .symbol {
            font-size: 1.5rem;
        }
        
        .timestamp {
            font-size: 0.8rem;
            color: #999;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .metric:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            color: #666;
            font-weight: 500;
        }
        
        .metric-value {
            font-weight: bold;
            color: #333;
        }
        
        .positive {
            color: #4CAF50;
        }
        
        .negative {
            color: #F44336;
        }
        
        .neutral {
            color: #FF9800;
        }
        
        .positions-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .positions-section h2 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .position-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .position-item:last-child {
            border-bottom: none;
        }
        
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 25px;
            color: white;
            font-weight: bold;
            z-index: 1000;
        }
        
        .connected {
            background: #4CAF50;
        }
        
        .disconnected {
            background: #F44336;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: white;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .status-bar {
                flex-direction: column;
            }
            
            .market-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">연결 중...</div>
    
    <div class="container">
        <div class="header">
            <h1>📊 트레이딩 모니터</h1>
            <p>48.5% 연수익률 최적화 전략 | Z-Score 기반 실시간 거래 시스템</p>
        </div>
        
        <div class="loading" id="loadingDiv">
            <div class="loading-spinner"></div>
            <p>API 서버 연결 중...</p>
        </div>
        
        <div id="mainContent" style="display: none;">
            <div class="status-bar">
                <div class="status-card">
                    <h3>시스템 상태</h3>
                    <div class="value" id="systemStatus">-</div>
                </div>
                <div class="status-card">
                    <h3>활성 포지션</h3>
                    <div class="value" id="activePositions">-</div>
                </div>
                <div class="status-card">
                    <h3>총 손익</h3>
                    <div class="value" id="totalPnl">-</div>
                </div>
                <div class="status-card">
                    <h3>거래 모드</h3>
                    <div class="value" id="tradingMode">-</div>
                </div>
                <div class="status-card">
                    <h3>승률</h3>
                    <div class="value" id="winRate">-</div>
                </div>
                <div class="status-card">
                    <h3>환율 (USD/KRW)</h3>
                    <div class="value" id="usdKrwRate">-</div>
                </div>
            </div>
            
            <div class="market-grid" id="marketGrid">
                <!-- 동적으로 생성됨 -->
            </div>
            
            <div class="positions-section">
                <h2>📊 현재 포지션</h2>
                <div id="positionsList">
                    <p style="text-align: center; color: #999; padding: 20px;">포지션이 없습니다</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';
        const WS_URL = 'ws://localhost:8080/ws';
        
        let ws = null;
        let reconnectInterval = null;
        
        // DOM 요소들
        const connectionStatus = document.getElementById('connectionStatus');
        const loadingDiv = document.getElementById('loadingDiv');
        const mainContent = document.getElementById('mainContent');
        const systemStatus = document.getElementById('systemStatus');
        const activePositions = document.getElementById('activePositions');
        const totalPnl = document.getElementById('totalPnl');
        const tradingMode = document.getElementById('tradingMode');
        const winRate = document.getElementById('winRate');
        const usdKrwRate = document.getElementById('usdKrwRate');
        const marketGrid = document.getElementById('marketGrid');
        const positionsList = document.getElementById('positionsList');
        
        // 초기화
        async function init() {
            try {
                // API 서버 상태 확인
                const healthCheck = await fetch(`${API_BASE}/health`);
                if (!healthCheck.ok) throw new Error('API 서버 응답 없음');
                
                loadingDiv.style.display = 'none';
                mainContent.style.display = 'block';
                
                // 초기 데이터 로드
                await loadInitialData();
                
                // WebSocket 연결
                connectWebSocket();
                
                // 주기적 데이터 갱신 (WebSocket 백업)
                setInterval(loadInitialData, 30000);
                
            } catch (error) {
                console.error('초기화 실패:', error);
                connectionStatus.textContent = 'API 서버 연결 실패';
                connectionStatus.className = 'connection-status disconnected';
            }
        }
        
        // 초기 데이터 로드
        async function loadInitialData() {
            try {
                // 시스템 상태
                const statusResponse = await fetch(`${API_BASE}/api/system-status`);
                if (statusResponse.ok) {
                    const status = await statusResponse.json();
                    updateSystemStatus(status);
                }
                
                // 시장 데이터
                const marketResponse = await fetch(`${API_BASE}/api/market-data`);
                if (marketResponse.ok) {
                    const marketData = await marketResponse.json();
                    updateMarketGrid(marketData);
                }
                
                // 포지션
                const positionsResponse = await fetch(`${API_BASE}/api/positions`);
                if (positionsResponse.ok) {
                    const positions = await positionsResponse.json();
                    updatePositions(positions);
                }
                
            } catch (error) {
                console.error('데이터 로드 실패:', error);
            }
        }
        
        // WebSocket 연결
        function connectWebSocket() {
            try {
                ws = new WebSocket(WS_URL);
                
                ws.onopen = () => {
                    connectionStatus.textContent = '실시간 연결됨';
                    connectionStatus.className = 'connection-status connected';
                    
                    // 구독 요청
                    ws.send(JSON.stringify({
                        type: 'subscribe',
                        data: { subscription: 'market_data' }
                    }));
                };
                
                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        handleWebSocketMessage(data);
                    } catch (error) {
                        console.error('WebSocket 메시지 파싱 오류:', error);
                    }
                };
                
                ws.onclose = () => {
                    connectionStatus.textContent = '연결 끊어짐';
                    connectionStatus.className = 'connection-status disconnected';
                    
                    // 재연결 시도
                    if (!reconnectInterval) {
                        reconnectInterval = setInterval(() => {
                            connectWebSocket();
                        }, 5000);
                    }
                };
                
                ws.onerror = (error) => {
                    console.error('WebSocket 오류:', error);
                };
                
            } catch (error) {
                console.error('WebSocket 연결 실패:', error);
                connectionStatus.textContent = 'WebSocket 연결 실패';
                connectionStatus.className = 'connection-status disconnected';
            }
        }
        
        // WebSocket 메시지 처리
        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'market_data':
                    updateMarketGrid(data.data);
                    break;
                case 'system_status':
                    updateSystemStatus(data.data);
                    break;
                case 'position_update':
                    loadInitialData(); // 포지션 업데이트시 전체 새로고침
                    break;
                case 'heartbeat':
                    // 연결 유지
                    break;
            }
        }
        
        // 시스템 상태 업데이트
        function updateSystemStatus(status) {
            systemStatus.textContent = status.is_running ? '실행 중' : '중지됨';
            systemStatus.className = status.is_running ? 'value positive' : 'value negative';
            
            activePositions.textContent = status.active_positions || 0;
            
            const pnl = status.total_pnl_krw || 0;
            totalPnl.textContent = `${(pnl/10000).toFixed(1)}만원`;
            totalPnl.className = pnl > 0 ? 'value positive' : pnl < 0 ? 'value negative' : 'value';
            
            // 거래 모드 표시
            tradingMode.textContent = status.dry_run ? '모의거래' : '실거래';
            tradingMode.className = status.dry_run ? 'value neutral' : 'value positive';
            
            // 승률 표시
            const winRateValue = status.win_rate || 0;
            winRate.textContent = `${winRateValue.toFixed(1)}%`;
            winRate.className = winRateValue > 80 ? 'value positive' : winRateValue > 60 ? 'value neutral' : 'value negative';
            
            usdKrwRate.textContent = (status.usd_krw_rate || 0).toLocaleString();
        }
        
        // 시장 데이터 업데이트
        function updateMarketGrid(marketData) {
            marketGrid.innerHTML = '';
            
            Object.entries(marketData).forEach(([symbol, data]) => {
                const card = createMarketCard(symbol, data);
                marketGrid.appendChild(card);
            });
        }
        
        // 시장 카드 생성
        function createMarketCard(symbol, data) {
            const card = document.createElement('div');
            card.className = 'market-card';
            
            const kimp = data.kimp || 0;
            const zscore = data.zscore || 0;
            const timestamp = new Date(data.timestamp).toLocaleTimeString();
            
            card.innerHTML = `
                <h2>
                    <span class="symbol">${symbol}</span>
                    <span class="timestamp">${timestamp}</span>
                </h2>
                <div class="metric">
                    <span class="metric-label">프리미엄</span>
                    <span class="metric-value ${kimp > 0 ? 'positive' : kimp < 0 ? 'negative' : 'neutral'}">${kimp.toFixed(2)}%</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Z-Score</span>
                    <span class="metric-value ${getZScoreStatusClass(zscore)}">${zscore.toFixed(3)}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">전략 신호</span>
                    <span class="metric-value ${getStrategySignalClass(zscore)}">${getStrategySignal(zscore)}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">업비트 가격</span>
                    <span class="metric-value">${(data.upbit_price || 0).toLocaleString()}원</span>
                </div>
                <div class="metric">
                    <span class="metric-label">바이낸스 가격</span>
                    <span class="metric-value">$${(data.binance_price || 0).toLocaleString()}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">환율</span>
                    <span class="metric-value">${(data.usd_krw || 0).toLocaleString()}</span>
                </div>
            `;
            
            return card;
        }
        
        // 포지션 업데이트
        function updatePositions(positions) {
            if (!positions || positions.length === 0) {
                positionsList.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">포지션이 없습니다</p>';
                return;
            }
            
            positionsList.innerHTML = '';
            positions.forEach(position => {
                const item = document.createElement('div');
                item.className = 'position-item';
                
                const pnl = position.current_pnl || 0;
                const pnlPct = position.current_pnl_pct || 0;
                
                item.innerHTML = `
                    <div>
                        <strong>${position.symbol}</strong>
                        <span style="margin-left: 10px; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; background: ${position.side === 'long' ? '#e8f5e8' : '#ffe8e8'}; color: ${position.side === 'long' ? '#2e7d2e' : '#d32f2f'};">
                            ${position.side.toUpperCase()}
                        </span>
                    </div>
                    <div style="text-align: right;">
                        <div class="${pnl > 0 ? 'positive' : pnl < 0 ? 'negative' : 'neutral'}" style="font-weight: bold;">
                            ${pnl.toLocaleString()}원 (${pnlPct.toFixed(2)}%)
                        </div>
                        <div style="font-size: 0.8rem; color: #999;">
                            진입: ${position.entry_kimp.toFixed(2)}%
                        </div>
                    </div>
                `;
                
                positionsList.appendChild(item);
            });
        }
        
        // Z-Score 상태 클래스 반환
        function getZScoreStatusClass(zscore) {
            const abs = Math.abs(zscore);
            if (abs >= 4.0) return 'negative'; // 초극단 - 빨간색
            if (abs >= 3.0) return 'neutral';  // 극단 - 주황색
            if (abs >= 2.0) return 'positive'; // 일반 - 녹색
            return '';  // 정상
        }
        
        // 전략 신호 텍스트 반환
        function getStrategySignal(zscore) {
            const abs = Math.abs(zscore);
            if (abs >= 4.0) return '초극단 (40%)';
            if (abs >= 3.0) return '극단 (2배)';
            if (abs >= 2.0) return '진입 신호';
            return '대기';
        }
        
        // 전략 신호 클래스 반환
        function getStrategySignalClass(zscore) {
            const abs = Math.abs(zscore);
            if (abs >= 4.0) return 'negative';  // 초극단
            if (abs >= 3.0) return 'neutral';   // 극단
            if (abs >= 2.0) return 'positive';  // 일반
            return '';
        }
        
        // 페이지 로드시 초기화
        document.addEventListener('DOMContentLoaded', init);
        
        // 페이지 종료시 WebSocket 정리
        window.addEventListener('beforeunload', () => {
            if (ws) {
                ws.close();
            }
            if (reconnectInterval) {
                clearInterval(reconnectInterval);
            }
        });
    </script>
</body>
</html>